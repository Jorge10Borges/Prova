---
// Modal reutilizable para mostrar detalle de producto
---
<div id="product-modal-overlay" class="fixed inset-0 z-[100] hidden">
  <!-- Fondo oscuro -->
  <div id="product-modal-backdrop" class="absolute inset-0 bg-black/80"></div>

  <!-- Contenedor (full en mobile, centrado en desktop) -->
  <div class="absolute inset-0 flex items-center justify-center p-0 md:p-6">
    <div id="product-modal" role="dialog" aria-modal="true" aria-labelledby="product-modal-title" class="relative w-full h-full md:h-auto md:max-h-[90vh] md:max-w-5xl bg-white md:rounded-xl md:overflow-hidden shadow-xl">
      <!-- Botón cerrar -->
      <button id="product-modal-close" type="button" aria-label="Cerrar" class="absolute right-3 top-3 z-10 inline-flex h-9 w-9 items-center justify-center rounded-full bg-black/60 text-white hover:bg-black/80 focus:outline-none focus:ring-2 focus:ring-white">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
      </button>

      <!-- Layout: columna en mobile (imagen arriba), columnas en desktop -->
      <div class="grid grid-rows-[auto_1fr] md:grid-rows-1 md:grid-cols-2 h-full">
        <!-- Imagen -->
        <div class="relative bg-black/5 max-h-[50vh] md:max-h-none">
          <img id="product-modal-image" src="" alt="" class="h-full w-full object-contain md:object-cover" />
        </div>
        <!-- Contenido -->
        <div class="flex min-h-0 flex-col p-4 md:p-6 overflow-y-auto md:mt-0 mt-5">
          <h3 id="product-modal-title" class="text-xl md:text-2xl font-bold text-prova-dark"></h3>
          <div class="mt-3">
            <span class="block text-[11px] md:text-xs font-semibold uppercase tracking-wide text-prova-red">Descripción</span>
            <p id="product-modal-desc" class="mt-2 whitespace-pre-line text-[15px] md:text-base text-gray-800 leading-relaxed bg-prova-gold/10 border border-prova-gold/30 rounded-lg p-3 shadow-sm"></p>
          </div>

          <!-- Detalles enriquecidos -->
          <div id="product-modal-details" class="mt-5 grid grid-cols-1 gap-3 text-sm md:text-base max-h-[50vh] overflow-y-auto overscroll-contain pr-1 rounded-lg border border-prova-gold/30 bg-prova-gold/5 p-3 md:p-4 shadow-sm">
            <div id="pm-presentacion" class="hidden relative pl-4 before:absolute before:left-0 before:top-2 before:h-2 before:w-2 before:rounded-full before:bg-prova-gold/80 text-[15px] md:text-base text-gray-800 leading-relaxed">
              <span class="mr-1 inline-block font-semibold text-prova-dark">Presentación:</span> <span class="value text-gray-700"></span>
            </div>
            <div id="pm-ingredientes" class="hidden relative pl-4 before:absolute before:left-0 before:top-2 before:h-2 before:w-2 before:rounded-full before:bg-prova-gold/80 text-[15px] md:text-base text-gray-800 leading-relaxed">
              <span class="mr-1 inline-block font-semibold text-prova-dark">Ingredientes:</span> <span class="value text-gray-700"></span>
            </div>
            <div id="pm-usos" class="hidden relative pl-4 before:absolute before:left-0 before:top-2 before:h-2 before:w-2 before:rounded-full before:bg-prova-gold/80 text-[15px] md:text-base text-gray-800 leading-relaxed">
              <span class="mr-1 inline-block font-semibold text-prova-dark">Usos recomendados:</span> <span class="value text-gray-700"></span>
            </div>
            <div id="pm-almacenamiento" class="hidden relative pl-4 before:absolute before:left-0 before:top-2 before:h-2 before:w-2 before:rounded-full before:bg-prova-gold/80 text-[15px] md:text-base text-gray-800 leading-relaxed">
              <span class="mr-1 inline-block font-semibold text-prova-dark">Almacenamiento:</span> <span class="value text-gray-700"></span>
            </div>
            <div id="pm-sku" class="hidden relative pl-4 before:absolute before:left-0 before:top-2 before:h-2 before:w-2 before:rounded-full before:bg-prova-gold/80 text-[15px] md:text-base text-gray-800 leading-relaxed">
              <span class="mr-1 inline-block font-semibold text-prova-dark">SKU:</span> <span class="value text-gray-700"></span>
            </div>
            <div id="pm-peso" class="hidden relative pl-4 before:absolute before:left-0 before:top-2 before:h-2 before:w-2 before:rounded-full before:bg-prova-gold/80 text-[15px] md:text-base text-gray-800 leading-relaxed">
              <span class="mr-1 inline-block font-semibold text-prova-dark">Peso:</span> <span class="value text-gray-700"></span>
            </div>
            <div id="pm-origen" class="hidden relative pl-4 before:absolute before:left-0 before:top-2 before:h-2 before:w-2 before:rounded-full before:bg-prova-gold/80 text-[15px] md:text-base text-gray-800 leading-relaxed">
              <span class="mr-1 inline-block font-semibold text-prova-dark">Origen:</span> <span class="value text-gray-700"></span>
            </div>
            <div id="pm-categoria" class="hidden relative pl-4 before:absolute before:left-0 before:top-2 before:h-2 before:w-2 before:rounded-full before:bg-prova-gold/80 text-[15px] md:text-base text-gray-800 leading-relaxed">
              <span class="mr-1 inline-block font-semibold text-prova-dark">Categoría:</span> <span class="value text-gray-700"></span>
            </div>
            <div id="pm-vidaUtil" class="hidden relative pl-4 before:absolute before:left-0 before:top-2 before:h-2 before:w-2 before:rounded-full before:bg-prova-gold/80 text-[15px] md:text-base text-gray-800 leading-relaxed">
              <span class="mr-1 inline-block font-semibold text-prova-dark">Vida útil:</span> <span class="value text-gray-700"></span>
            </div>
            <div id="pm-alergenos" class="hidden relative pl-4 before:absolute before:left-0 before:top-2 before:h-2 before:w-2 before:rounded-full before:bg-prova-gold/80 text-[15px] md:text-base text-gray-800 leading-relaxed">
              <span class="mr-1 inline-block font-semibold text-prova-dark">Alérgenos:</span> <span class="value text-gray-700"></span>
            </div>
            <div id="pm-preparacion" class="hidden relative pl-4 before:absolute before:left-0 before:top-2 before:h-2 before:w-2 before:rounded-full before:bg-prova-gold/80 text-[15px] md:text-base text-gray-800 leading-relaxed">
              <span class="mr-1 inline-block font-semibold text-prova-dark">Preparación sugerida:</span> <span class="value text-gray-700"></span>
            </div>
          </div>

          <!-- Acciones opcionales -->
          <div class="mt-6 flex flex-wrap gap-3">
            <button type="button" id="product-modal-action" class="inline-flex items-center gap-2 rounded-md bg-prova-red px-4 py-2 text-white hover:bg-red-800 transition">
              Contactar por WhatsApp
            </button>
            <button type="button" id="product-modal-close-2" class="inline-flex items-center gap-2 rounded-md border border-gray-300 px-4 py-2 text-gray-800 hover:bg-gray-100 transition">
              Cerrar
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // Utilidades básicas del modal
  const $overlay = document.getElementById('product-modal-overlay') as HTMLElement | null;
  const $modal = document.getElementById('product-modal') as HTMLElement | null;
  const $backdrop = document.getElementById('product-modal-backdrop') as HTMLElement | null;
  const $btnClose = document.getElementById('product-modal-close') as HTMLButtonElement | null;
  const $btnClose2 = document.getElementById('product-modal-close-2') as HTMLButtonElement | null;
  const $img = document.getElementById('product-modal-image') as HTMLImageElement | null;
  const $title = document.getElementById('product-modal-title') as HTMLElement | null;
  const $desc = document.getElementById('product-modal-desc') as HTMLElement | null;
  const $action = document.getElementById('product-modal-action') as HTMLButtonElement | null;
  // Campos de detalles
  const $pm = {
    presentacion: document.querySelector('#pm-presentacion') as HTMLElement | null,
    ingredientes: document.querySelector('#pm-ingredientes') as HTMLElement | null,
    usos: document.querySelector('#pm-usos') as HTMLElement | null,
    almacenamiento: document.querySelector('#pm-almacenamiento') as HTMLElement | null,
    sku: document.querySelector('#pm-sku') as HTMLElement | null,
    peso: document.querySelector('#pm-peso') as HTMLElement | null,
    origen: document.querySelector('#pm-origen') as HTMLElement | null,
    categoria: document.querySelector('#pm-categoria') as HTMLElement | null,
    vidaUtil: document.querySelector('#pm-vidaUtil') as HTMLElement | null,
    alergenos: document.querySelector('#pm-alergenos') as HTMLElement | null,
    preparacion: document.querySelector('#pm-preparacion') as HTMLElement | null,
  };

  function openModal(data: { image?: string; title?: string; desc?: string; whatsapp?: string; presentacion?: string; ingredientes?: string; usos?: string; almacenamiento?: string; sku?: string; peso?: string; origen?: string; categoria?: string; vidaUtil?: string; alergenos?: string; preparacion?: string; }) {
    if (!$overlay) return;
    // Rellenar contenido
    if ($img && data.image) {
      $img.src = data.image;
      $img.alt = data.title || 'Producto';
    }
    if ($title) $title.textContent = data.title || '';
    if ($desc) $desc.textContent = data.desc || '';
    if ($action) {
      const wa = data.whatsapp;
      if (wa) {
        $action.onclick = () => {
          window.open(wa, '_blank');
        };
        $action.classList.remove('hidden');
      } else {
        $action.onclick = null;
        $action.classList.add('hidden');
      }
    }
    // Rellenar detalles (mostrar/ocultar según haya valor)
    const map: [keyof typeof $pm, keyof typeof data][] = [
      ['presentacion', 'presentacion'],
      ['ingredientes', 'ingredientes'],
      ['usos', 'usos'],
      ['almacenamiento', 'almacenamiento'],
      ['sku', 'sku'],
      ['peso', 'peso'],
      ['origen', 'origen'],
      ['categoria', 'categoria'],
      ['vidaUtil', 'vidaUtil'],
      ['alergenos', 'alergenos'],
      ['preparacion', 'preparacion'],
    ];
    for (const [pmKey, dataKey] of map) {
      const section = $pm[pmKey];
      if (!section) continue;
      const valueSpan = section.querySelector('.value') as HTMLElement | null;
      const value = (data as any)[dataKey] as string | undefined;
      if (value && value.trim()) {
        if (valueSpan) valueSpan.textContent = value.trim();
        section.classList.remove('hidden');
      } else {
        if (valueSpan) valueSpan.textContent = '';
        section.classList.add('hidden');
      }
    }
    // Mostrar
    $overlay.classList.remove('hidden');
    document.documentElement.classList.add('overflow-hidden');
    document.body.classList.add('overflow-hidden');
  }

  function closeModal() {
    if (!$overlay) return;
    $overlay.classList.add('hidden');
    document.documentElement.classList.remove('overflow-hidden');
    document.body.classList.remove('overflow-hidden');
  }

  // Cierres
  $backdrop?.addEventListener('click', closeModal);
  $btnClose?.addEventListener('click', closeModal);
  $btnClose2?.addEventListener('click', closeModal);
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') closeModal();
  });

  // Delegación: botones con data-open-product-modal
  document.addEventListener('click', (e) => {
    const target = e.target as HTMLElement;
    const btn = target.closest('[data-open-product-modal]') as HTMLElement | null;
    if (!btn) return;
    e.preventDefault();
    const image = btn.getAttribute('data-image') || '';
    const title = btn.getAttribute('data-title') || '';
    const desc = btn.getAttribute('data-desc') || '';
  const whatsapp = btn.getAttribute('data-whatsapp') || '';
  const presentacion = btn.getAttribute('data-presentacion') || '';
  const ingredientes = btn.getAttribute('data-ingredientes') || '';
  const usos = btn.getAttribute('data-usos') || '';
  const almacenamiento = btn.getAttribute('data-almacenamiento') || '';
  const sku = btn.getAttribute('data-sku') || '';
  const peso = btn.getAttribute('data-peso') || '';
  const origen = btn.getAttribute('data-origen') || '';
  const categoria = btn.getAttribute('data-categoria') || '';
  const vidaUtil = btn.getAttribute('data-vida-util') || '';
  const alergenos = btn.getAttribute('data-alergenos') || '';
  const preparacion = btn.getAttribute('data-preparacion') || '';
  openModal({ image, title, desc, whatsapp, presentacion, ingredientes, usos, almacenamiento, sku, peso, origen, categoria, vidaUtil, alergenos, preparacion });
  });
</script>
